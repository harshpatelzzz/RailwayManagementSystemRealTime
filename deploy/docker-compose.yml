version: '3.8'

services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: railsewa-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-twitter}
      MYSQL_USER: ${DB_USER:-railsewa}
      MYSQL_PASSWORD: ${DB_PASSWORD:-railsewa123}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../database/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - railsewa-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: railsewa-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - railsewa-network

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: railsewa-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - railsewa-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Apache Spark Master
  spark-master:
    image: bitnami/spark:latest
    container_name: railsewa-spark-master
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8080:8080"
      - "7077:7077"
    networks:
      - railsewa-network

  # Apache Spark Worker
  spark-worker:
    image: bitnami/spark:latest
    container_name: railsewa-spark-worker
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    volumes:
      - ../:/app
    networks:
      - railsewa-network

  # PHP Web Server
  php-apache:
    image: php:8.1-apache
    container_name: railsewa-web
    depends_on:
      - mysql
    ports:
      - "80:80"
    volumes:
      - ../railways:/var/www/html
      - ../assets:/var/www/html/assets
    environment:
      - DB_HOST=mysql
      - DB_USER=${DB_USER:-railsewa}
      - DB_PASSWORD=${DB_PASSWORD:-railsewa123}
      - DB_NAME=${DB_NAME:-twitter}
    networks:
      - railsewa-network
    command: >
      bash -c "
      docker-php-ext-install mysqli pdo pdo_mysql &&
      a2enmod rewrite &&
      apache2-foreground
      "

volumes:
  mysql_data:

networks:
  railsewa-network:
    driver: bridge

